@startuml Class Diagram
!theme plain
skinparam classAttributeIconSize 0

package "drone_orchestrator" {
  class Orchestrator {
    - RVO::RVOSimulator* simulator
    - size_t numDrones
    - std::vector<RVO::Vector3> dronePreferredVelocities
    - std::vector<RVO::Vector3> droneGoals
    --
    + Orchestrator(initial_pos, timeStep, neighborDist, maxNeighbors, timeHorizon, radius, maxSpeed)
    + setWebotDronePositionsAndVelocities(positions, velocities) : void
    + setWebotPrefferedVelocities() : void
    + setWebotDroneGoals(goals) : void
    + reachedGoals(goals) : bool
    + getNewVelocities() : std::vector<RVO::Vector3>
    + getWebotDroneGoal(drone_id) : RVO::Vector3
    + getWebotDronePosition(drone_id) : RVO::Vector3
    + getWebotDroneVelocity(drone_id) : RVO::Vector3
    + getDronePreferredVelocity(drone_id) : RVO::Vector3
    + ~Orchestrator()
  }
  
  class "RVO::RVOSimulator" {
    + setTimeStep(timeStep) : void
    + addAgent(position) : void
    + getNumAgents() : size_t
    + setAgentPosition(id, position) : void
    + setAgentVelocity(id, velocity) : void
    + setAgentPrefVelocity(id, velocity) : void
    + getAgentPosition(id) : RVO::Vector3
    + getAgentVelocity(id) : RVO::Vector3
    + doStep() : void
  }
  
  class "RVO::Vector3" {
    + x() : float
    + y() : float
    + z() : float
  }
  
  Orchestrator *-- "RVO::RVOSimulator" : uses
  Orchestrator --> "RVO::Vector3" : uses
  "RVO::RVOSimulator" --> "RVO::Vector3" : uses
}

package "drone_controller" {
  class MinimalSubscriber {
    - int numSubs
    - std::vector<POS_SUBSCRIBER> position_subscribers_
    - std::vector<VEL_SUBSCRIBER> velocity_subscribers_
    - std::vector<VEL_PUBLISHER> velocity_publishers_
    - std::vector<RVO::Vector3> drone_positions_
    - std::vector<RVO::Vector3> drone_velocities_
    - TIMER timer_
    - Orchestrator orchestrator_
    - std::queue<char> letters_queue_
    - std::vector<RVO::Vector3> goals
    --
    + MinimalSubscriber()
    - position_callback(msg, idx) : void
    - velocity_callback(msg, idx) : void
    - timer_callback() : void
  }
  
  class MinimalPublisher {
    - size_t count_
    - PUBLISHER publisher_
    - TIMER timer_
    --
    + MinimalPublisher()
    - timer_callback() : void
  }
  
  MinimalSubscriber --> Orchestrator : uses
  MinimalSubscriber --> "RVO::Vector3" : uses
}

package "mavic_simulation" {
  class MavicDriver {
    - robot
    - timestep
    - gps
    - gyro
    - imu
    - propellers[4]
    - target_twist : Twist
    - vertical_ref : float
    - linear_x_integral : float
    - linear_y_integral : float
    - node : rclpy.Node
    --
    + init(webots_node, properties) : void
    + step() : void
    - __cmd_vel_callback(twist) : void
  }
}

package "ROS2 Messages" {
  class "geometry_msgs::msg::PointStamped" {
    + point : Point
    + header : Header
  }
  
  class "geometry_msgs::msg::Vector3" {
    + x : float
    + y : float
    + z : float
  }
  
  class "geometry_msgs::msg::Twist" {
    + linear : Vector3
    + angular : Vector3
  }
  
  class "std_msgs::msg::String" {
    + data : string
  }
}

package "ROS2 Core" {
  class "rclcpp::Node" {
    + create_subscription() : Subscription
    + create_publisher() : Publisher
    + create_wall_timer() : Timer
    + get_logger() : Logger
  }
  
  class "rclcpp::Subscription" {
    + receive() : void
  }
  
  class "rclcpp::Publisher" {
    + publish(msg) : void
  }
  
  class "rclcpp::Timer" {
    + callback() : void
  }
}

MinimalSubscriber --|> "rclcpp::Node" : extends
MinimalPublisher --|> "rclcpp::Node" : extends
MinimalSubscriber --> "geometry_msgs::msg::PointStamped" : subscribes
MinimalSubscriber --> "geometry_msgs::msg::Vector3" : subscribes
MinimalSubscriber --> "geometry_msgs::msg::Twist" : publishes
MinimalPublisher --> "std_msgs::msg::String" : publishes
MavicDriver --> "geometry_msgs::msg::Twist" : subscribes

note right of Orchestrator
  Uses RVO (Reciprocal Velocity Obstacles)
  algorithm for multi-agent path planning
  and collision avoidance
end note

note right of MinimalSubscriber
  Main controller node that:
  - Subscribes to drone positions/velocities
  - Uses Orchestrator for path planning
  - Publishes velocity commands
  - Handles letter writing sequence
end note

@enduml

