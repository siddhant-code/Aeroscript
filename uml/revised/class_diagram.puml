@startuml Class Diagram
!theme plain
skinparam classAttributeIconSize 0

package "drone_orchestrator" {
  class Orchestrator {
    - RVO::RVOSimulator* simulator_
    - size_t num_drones_
    - std::vector<RVO::Vector3> drone_preferred_velocities_
    - std::vector<RVO::Vector3> drone_goals_
    --
    + Orchestrator(initialPos, timeStep, neighborDist, maxNeighbors, timeHorizon, radius, maxSpeed)
    + SetWebotDronePositionsAndVelocities(positions, velocities) : void
    + SetWebotPrefferedVelocities() : void
    + SetWebotDroneGoals(goals) : void
    + ReachedGoals() : bool
    + GetNewVelocities() : std::vector<RVO::Vector3>
    + GetWebotDroneGoal(drone_id) : RVO::Vector3
    + GetWebotDronePosition(drone_id) : RVO::Vector3
    + GetWebotDroneVelocity(drone_id) : RVO::Vector3
    + GetDronePreferredVelocity(drone_id) : RVO::Vector3
    + ~Orchestrator()
  }
  
  class "RVO::RVOSimulator" {
    + setTimeStep(timeStep) : void
    + addAgent(position) : void
    + getNumAgents() : size_t
    + setAgentPosition(id, position) : void
    + setAgentVelocity(id, velocity) : void
    + setAgentPrefVelocity(id, velocity) : void
    + getAgentPosition(id) : RVO::Vector3
    + getAgentVelocity(id) : RVO::Vector3
    + doStep() : void
  }
  
  class "RVO::Vector3" {
    + x() : float
    + y() : float
    + z() : float
  }
  
  Orchestrator *-- "RVO::RVOSimulator" : uses
  Orchestrator --> "RVO::Vector3" : uses
  "RVO::RVOSimulator" --> "RVO::Vector3" : uses
}

package "drone_controller" {
  class DroneManager {
    - int num_drones_
    - std::vector<POS_SUBSCRIBER> position_subscribers_
    - std::vector<VEL_SUBSCRIBER> velocity_subscribers_
    - std::vector<VEL_PUBLISHER> velocity_publishers_
    - std::vector<RVO::Vector3> drone_positions_
    - std::vector<RVO::Vector3> drone_velocities_
    - TIMER timer_
    - Orchestrator orchestrator_
    - std::queue<char> letters_queue_
    - std::vector<RVO::Vector3> goals_
    --
    + DroneManager()
    - PositionCallback(msg, idx) : void
    - VelocityCallback(msg, idx) : void
    - TimerCallback() : void
  }
  
  class "GetGoalsForLetter" <<function>> {
    + GetGoalsForLetter(letter, csv_path) : std::vector<RVO::Vector3>
  }
  
  DroneManager --> Orchestrator : uses
  DroneManager --> "RVO::Vector3" : uses
  DroneManager ..> "GetGoalsForLetter" : calls
}

package "mavic_simulation" {
  class MavicDriver {
    - rclcpp::Subscription<geometry_msgs::msg::Twist>::SharedPtr cmd_vel_subscription_
    - geometry_msgs::msg::Twist target_twist
    - std::array<WbDeviceTag, 4> propellers
    - WbDeviceTag gps
    - WbDeviceTag imu
    - WbDeviceTag gyro
    - float vertical_ref
    - float linear_x_integral
    - float linear_y_integral
    - int timestep
    - std::string name
    --
    + init(node, parameters) : void
    + step() : void
  }
  
  class "webots_ros2_driver::PluginInterface" {
    + init(node, parameters) : void
    + step() : void
  }
  
  MavicDriver --|> "webots_ros2_driver::PluginInterface" : implements
}

package "ROS2 Messages" {
  class "geometry_msgs::msg::PointStamped" {
    + point : Point
    + header : Header
  }
  
  class "geometry_msgs::msg::Vector3" {
    + x : float
    + y : float
    + z : float
  }
  
  class "geometry_msgs::msg::Twist" {
    + linear : Vector3
    + angular : Vector3
  }
  
  class "geometry_msgs::msg::Point" {
    + x : float
    + y : float
    + z : float
  }
}

package "ROS2 Core" {
  class "rclcpp::Node" {
    + create_subscription() : Subscription
    + create_publisher() : Publisher
    + create_wall_timer() : Timer
    + get_logger() : Logger
    + declare_parameter() : void
    + get_parameter() : Parameter
  }
  
  class "rclcpp::Subscription" {
    + receive() : void
  }
  
  class "rclcpp::Publisher" {
    + publish(msg) : void
  }
  
  class "rclcpp::Timer" {
    + callback() : void
  }
}

DroneManager --|> "rclcpp::Node" : extends
DroneManager --> "geometry_msgs::msg::PointStamped" : subscribes
DroneManager --> "geometry_msgs::msg::Vector3" : subscribes
DroneManager --> "geometry_msgs::msg::Twist" : publishes
MavicDriver --> "geometry_msgs::msg::Twist" : subscribes

note right of Orchestrator
  Uses RVO (Reciprocal Velocity Obstacles)
  algorithm for multi-agent path planning
  and collision avoidance.
  
  Default parameters:
  - timeStep: 0.008s (125Hz)
  - neighborDist: 3.0m
  - maxNeighbors: 20
  - timeHorizon: 3.5s
  - radius: 0.4m
  - maxSpeed: 0.5 m/s
end note

note right of DroneManager
  Main controller node that:
  - Subscribes to drone positions/velocities
  - Uses Orchestrator for path planning
  - Publishes velocity commands
  - Handles letter writing sequence
  - Manages CSV file loading
  - 8ms timer (125Hz control loop)
end note

note right of MavicDriver
  C++ Webots plugin that:
  - Controls individual drone
  - Reads sensors (GPS, IMU, Gyro)
  - Controls 4 propellers
  - Implements PID control
  - Publishes sensor data
end note

@enduml

